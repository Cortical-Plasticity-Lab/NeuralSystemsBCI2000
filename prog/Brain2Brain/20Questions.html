<!DOCTYPE html>
<html lang="en">
	<head>
		<title>20 Questions</title>
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

        <link rel="stylesheet" type="text/css" href="Style.css" />
        <link rel="stylesheet" type="text/css" href="20Questions/Style.css" />
        <script type="text/javascript" src="Constants.js"></script>
        <script type="text/javascript" src="Poller.js"></script>
        <script type="text/javascript" src="Logger.js"></script>
        <script type="text/javascript" src="API.js"></script>
        <script type="text/javascript" src="20Questions/Constants.js"></script>
        <script type="text/javascript" src="20Questions/Tree.js"></script>
		<script type="text/javascript">
			window.onload = function() {
                // Initialize the file selection pop-up
                $('#FileSelectionPrompt').dialog({
                    autoOpen: true,
                    modal: true,
                    closeOnEscape: false, 
                    buttons: {
                        "Select" : function() {
                            // Load the file into a tree
                            InitializeQuestionTree('/20Questions/' + $('#FileSelector').val());
                            $(this).dialog('close');
                        }
                    }
                });

                // Initialize the trial-end pop-up
                $('#ConfirmationPrompt').dialog({
                    autoOpen: false,
                    width: 350,
                    modal: true,
                    closeOnEscape: false, 
                    buttons: {
                        "Yes" : function() {
                            LogInfo('Positive answer received');
                            AnswerQuestion(true);
                            $(this).dialog("close");
                        },
                        "No" : function() {
                            LogInfo('Negative answer received');
                            AnswerQuestion(false);
                            $(this).dialog('close');
                        }
                    },
                    open: function(event, ui) {
                        $('#ConfirmationText').show();
                        $('#ConfirmationEllipses').text('');
                        var buttons = $('#ConfirmationPrompt + .ui-dialog-buttonpane > .ui-dialog-buttonset');

                        // Hide the buttons for a moment
                        buttons.hide();

                        // Prevent the Yes/No prompt from being used until the trial is over
                        var counter = function() {
                            var ellipses = $('#ConfirmationEllipses');

                            if (ellipses.text().length > TRIAL_TIME / 1000) {
                                $('#ConfirmationText').hide();
                                buttons.show();
                            } else {
                                ellipses.text(ellipses.text() + '.');
                                setTimeout(counter, 1000);
                            }
                        }
                        counter();
                    }, 
                    close: function(event, ui) {
                        POST_TrialStop(function() {}, function() {});
                    }
                });

                // Start polling the server for hits
                PollServer();
			};

            /**
             * Takes the selected question/answer and asks the BCI-side for an answer
             */
            SubmitQuestion = function(text, isQuestion) {
                // Extract the question to ask
                var question = text;
                if (!isQuestion) {
                    question = 'Is it a ' + text + '?';
                }

                // Ask the BCI for an answer
                LogInfo('Asking question: ' + question);
                POST_TrialStart(question,
                    function() {
                        $('#ConfirmationPrompt').dialog('open');
                    },
                    function() {
                        alert('Application suspended, press OK to try again');
                        SubmitQuestion(text, isQuestion);
                    });
            };
		</script>
	</head>
	<body tabindex="0">
        <div id="FileSelectionPrompt" title="Choose a question file:">
            <select id="FileSelector">
                <option value="animals.txt">Animals</option>
                <option value="question2.txt">Animals (minimal)</option>
                <option value="simple.txt">Simple</option>
            </select>
        </div>
        <div id="ConfirmationPrompt" title="Did you see a flash of light?">
            <div id="ConfirmationText">
                Waiting for answer<span id="ConfirmationEllipses"></span>
            </div>
        </div>
        <div id="QuestionTree"></div>
	</body>
</html>
