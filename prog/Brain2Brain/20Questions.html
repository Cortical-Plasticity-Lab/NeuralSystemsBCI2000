<!DOCTYPE html>
<html lang="en">
	<head>
		<title>20 Questions</title>
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

        <link rel="stylesheet" type="text/css" href="Style.css" />
        <link rel="stylesheet" type="text/css" href="20Questions/Style.css" />
        <script type="text/javascript" src="Constants.js"></script>
        <script type="text/javascript" src="Poller.js"></script>
        <script type="text/javascript" src="Logger.js"></script>
        <script type="text/javascript" src="API.js"></script>
        <script type="text/javascript" src="20Questions/Constants.js"></script>
        <script type="text/javascript" src="20Questions/Tree.js"></script>
		<script type="text/javascript">
			window.onload = function() {
                // Initialize the trial-starting buttons
                $('#SubmitButton').button()
                .click(function() {
                    SubmitQuestion($('#QuestionsList > li.ui-selected'), true);
                    SubmitQuestion($('#AnswersList > li.ui-selected'), false);
                });

                // Initialize the file selection pop-up
                $('#FileSelectionPrompt').dialog({
                    autoOpen: true,
                    modal: true,
                    closeOnEscape: false, 
                    buttons: {
                        "Select" : function() {
                            // Load the file into a tree
                            InitializeQuestionMatrix('/20Questions/' + $('#FileSelector').val());
                            $(this).dialog('close');
                        }
                    }
                });

                // Initialize the trial-end pop-up
                $('#ConfirmationPrompt').dialog({
                    autoOpen: false,
                    width: 350,
                    modal: true,
                    closeOnEscape: false, 
                    buttons: {
                        "Yes" : function() {
                            LogInfo('Positive answer received');

                            // Was it a question or answer?
                            var question = $('#QuestionsList > li.ui-selected');
                            var answer = $('#AnswersList > li.ui-selected');
                            if (question.length > 0) {
                                AnswerQuestion(question.filter(':first').text(), true);

                            // Yay, victory(?)!
                            } else if (answer.length > 0) {
                                alert('Game complete!\nClose this alert to refresh the page');
                                location.reload();

                            } else {
                                alert('Incorrect client state: ' +
                                      'One question/answer must be selected for this dialog to appear');
                            }
                            $(this).dialog("close");
                        },
                        "No" : function() {
                            LogInfo('Negative answer received');

                            // Prune the question asked off the tree
                            var question = $('#QuestionsList > li.ui-selected, #AnswersList > li.ui-selected');
                            if (question.length > 0) {
                                AnswerQuestion(question.filter(':first').text(), false);

                            } else {
                                alert('Incorrect client state: ' +
                                      'One question/answer must be selected for this dialog to appear');
                            }
                            $(this).dialog('close');
                        }
                    },
                    open: function(event, ui) {
                        $('#ConfirmationText').show();
                        $('#ConfirmationEllipses').text('');
                        var buttons = $('#ConfirmationPrompt + .ui-dialog-buttonpane > .ui-dialog-buttonset');

                        // Hide the buttons for a moment
                        buttons.hide();

                        // Prevent the Yes/No prompt from being used until the trial is over
                        var counter = function() {
                            var ellipses = $('#ConfirmationEllipses');

                            if (ellipses.text().length > TRIAL_TIME / 1000) {
                                $('#ConfirmationText').hide();
                                buttons.show();
                            } else {
                                ellipses.text(ellipses.text() + '.');
                                setTimeout(counter, 1000);
                            }
                        }
                        counter();
                    }, 
                    close: function(event, ui) {
                        POST_TrialStop(function() {}, function() {});
                    }
                });

                // Start polling the server for hits
                PollServer();
			};

            /**
             * Takes the selected question/answer and asks the BCI-side for an answer
             */
            SubmitQuestion = function(selected, isQuestion) {
                // Anything selected?
                if (selected.length <= 0) {
                    return;
                }

                // Extract the question to ask
                var question = selected.filter(':first').text();
                if (!isQuestion) {
                    question = 'Is it a ' + question + '?';
                }

                // Ask the BCI for an answer
                LogInfo('Asking question: ' + question);
                POST_TrialStart(question,
                    function() {
                        $('#ConfirmationPrompt').dialog('open');
                    },
                    function() {
                        alert('Application suspended, please try again in a moment');
                    });
            };
		</script>
	</head>
	<body tabindex="0">
        <div id="FileSelectionPrompt" title="Choose a question file:">
            <select id="FileSelector">
                <option value="Questions-Animal-01.csv">Animal #1</option>
                <option value="Questions-Animal-02.csv">Animal #2</option>
                <option value="Questions-Food-01.csv">Food</option>
                <option value="Questions-Person-01.csv">People #1</option>
                <option value="Questions-Person-02.csv">People #2</option>
                <option value="Questions-Object-01.csv">Object #1</option>
                <option value="Questions-Object-02.csv">Object #2</option>
            </select>
        </div>
        <div id="ConfirmationPrompt" title="Did you see a flash of light?">
            <div id="ConfirmationText">
                Waiting for answer<span id="ConfirmationEllipses"></span>
            </div>
        </div>
        <div id="QuestionsBox">
            <div id="QuestionsLabel">Questions</div>
            <ul id="QuestionsList"></ul>
        </div>
        <div id="AnswersBox">
            <div id="AnswersLabel">Answers</div>
            <ul id="AnswersList"></ul>
        </div>
        <div id="SubmitButton">Submit</div>
	</body>
</html>
